generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// PLATFORM & SCHOOLS (Multi-Tenancy)
// ============================================

enum SchoolType {
  PRIMARY
  SECONDARY
  TERTIARY
}

enum SchoolStatus {
  PENDING_VERIFICATION
  VERIFIED
  PAYMENT_PENDING
  ACTIVE
  SUSPENDED
  CANCELLED
}

enum SubscriptionPlan {
  ESSENTIAL
  PROFESSIONAL
  ENTERPRISE
  PREMIUM
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  EXPIRED
  CANCELLED
}

model School {
  id                    String             @id @default(cuid())
  name                  String
  type                  SchoolType
  email                 String             @unique
  phone                 String
  address               String
  state                 String
  lga                   String
  contactPersonName     String
  contactPersonRole     String
  contactPersonPhone    String
  estimatedStudentCount Int
  subdomain             String             @unique
  customDomain          String?            @unique
  logoUrl               String?
  primaryColor          String?            @default("#1e3a8a")
  secondaryColor        String?            @default("#ffffff")
  status                SchoolStatus       @default(PENDING_VERIFICATION)
  subscriptionPlan      SubscriptionPlan?
  subscriptionStatus    SubscriptionStatus @default(TRIAL)
  subscriptionStartDate DateTime?
  subscriptionEndDate   DateTime?
  studentCount          Int                @default(0) // Actual count for billing
  paymentMethod         String?
  billingEmail          String?
  verificationDocuments Json?              // URLs to uploaded documents
  rejectionReason       String?
  websiteUrl            String?
  motto                 String?
  vision                String?
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt

  // Relations
  users                 User[]
  subscriptions         Subscription[]
  payments              Payment[]
  teachers              Teacher[]
  students              Student[]
  parents               Parent[]
  classes               Class[]
  subjects              Subject[]
  results               Result[]
  exams                 Exam[]
  academicYears         AcademicYear[]
  gradingScales         GradingScale[]
  bugReports            BugReport[]

  @@map("schools")
}

model Subscription {
  id         String             @id @default(cuid())
  schoolId   String
  plan       SubscriptionPlan
  amount     Float
  currency   String             @default("NGN")
  interval   String             // MONTHLY, QUARTERLY, ANNUAL
  status     SubscriptionStatus
  startDate  DateTime
  endDate    DateTime
  autoRenew  Boolean            @default(true)
  createdAt  DateTime           @default(now())
  updatedAt  DateTime           @updatedAt

  // Relations
  school     School             @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  payments   Payment[]

  @@map("subscriptions")
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

model Payment {
  id             String        @id @default(cuid())
  schoolId       String
  subscriptionId String?
  amount         Float
  currency       String        @default("NGN")
  paymentMethod  String
  transactionId  String?       @unique
  status         PaymentStatus @default(PENDING)
  paidAt         DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  // Relations
  school         School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  subscription   Subscription? @relation(fields: [subscriptionId], references: [id])

  @@map("payments")
}

// ============================================
// USERS & AUTHENTICATION
// ============================================

enum UserRole {
  MANUFACTURER  // Platform owner
  SCHOOL_ADMIN  // School's primary admin
  ADMIN         // School's secondary admin
  HOD           // Head of Department
  TEACHER
  PARENT
  STUDENT
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

model User {
  id        String     @id @default(cuid())
  schoolId  String?    // NULL for MANUFACTURER
  email     String     @unique
  password  String
  name      String
  role      UserRole
  status    UserStatus @default(ACTIVE)
  
  // Security fields
  requirePasswordChange Boolean         @default(false)
  passwordChangedAt     DateTime?
  lastLoginAt           DateTime?
  lastLoginIp           String?
  failedLoginAttempts   Int             @default(0)
  lockedUntil           DateTime?
  mfaEnabled            Boolean         @default(false)
  mfaSecret             String?
  
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  // Relations
  school    School?    @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  teacher   Teacher?
  parent    Parent?
  student   Student?
  passwordHistory       PasswordHistory[]
  loginAttempts         LoginAttempt[]
  sessions              Session[]
  auditLogs             AuditLog[]

  @@index([schoolId])
  @@index([email])
  @@map("users")
}

// ============================================
// ACADEMIC STRUCTURE
// ============================================

enum ClassLevel {
  JSS1
  JSS2
  JSS3
  SSS1
  SSS2
  SSS3
}

model Class {
  id          String     @id @default(cuid())
  schoolId    String
  name        String
  level       ClassLevel
  capacity    Int        @default(40)
  teacherId   String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relations
  school      School     @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  teacher     Teacher?   @relation(fields: [teacherId], references: [id])
  students    Student[]
  subjects    ClassSubject[]
  exams       Exam[]

  @@index([schoolId])
  @@map("classes")
}

enum SubjectCategory {
  CORE
  ELECTIVE
}

model Subject {
  id          String          @id @default(cuid())
  schoolId    String
  name        String
  code        String
  category    SubjectCategory @default(CORE)
  description String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  // Relations
  school      School          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  classes     ClassSubject[]
  results     Result[]
  exams       Exam[]

  @@unique([schoolId, code])
  @@index([schoolId])
  @@map("subjects")
}

model ClassSubject {
  id        String   @id @default(cuid())
  classId   String
  subjectId String
  teacherId String
  createdAt DateTime @default(now())

  // Relations
  class     Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  subject   Subject  @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  teacher   Teacher  @relation(fields: [teacherId], references: [id])

  @@unique([classId, subjectId])
  @@map("class_subjects")
}

// ============================================
// PEOPLE
// ============================================

model Teacher {
  id              String   @id @default(cuid())
  schoolId        String
  userId          String   @unique
  employeeId      String
  phone           String?
  address         String?
  qualification   String?
  specialization  String?
  dateOfBirth     DateTime?
  hireDate        DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  school          School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  classes         Class[]
  classSubjects   ClassSubject[]
  results         Result[]

  @@unique([schoolId, employeeId])
  @@index([schoolId])
  @@map("teachers")
}

enum Gender {
  MALE
  FEMALE
}

model Student {
  id              String    @id @default(cuid())
  schoolId        String
  userId          String    @unique
  studentId       String
  classId         String
  parentId        String?
  phone           String?
  address         String?
  dateOfBirth     DateTime?
  gender          Gender?
  admissionDate   DateTime  @default(now())
  medicalInfo     String?
  emergencyContact String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  school          School    @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  class           Class     @relation(fields: [classId], references: [id])
  parent          Parent?   @relation(fields: [parentId], references: [id])
  results         Result[]
  examAttempts    ExamAttempt[]

  @@unique([schoolId, studentId])
  @@index([schoolId])
  @@map("students")
}

model Parent {
  id              String    @id @default(cuid())
  schoolId        String
  userId          String    @unique
  phone           String?
  address         String?
  occupation      String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  school          School    @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  children        Student[]

  @@index([schoolId])
  @@map("parents")
}

// ============================================
// RESULTS & GRADING
// ============================================

enum Term {
  FIRST
  SECOND
  THIRD
}

enum ResultStatus {
  DRAFT
  SUBMITTED
  HOD_APPROVED
  ADMIN_APPROVED
  PUBLISHED
  REJECTED
}

enum Grade {
  A
  B
  C
  D
  E
  F
}

model Result {
  id          String       @id @default(cuid())
  schoolId    String
  studentId   String
  subjectId   String
  teacherId   String
  academicYear String
  term        Term
  caScore     Float        @default(0)
  examScore   Float        @default(0)
  totalScore  Float        @default(0)
  grade       Grade?
  position    Int?
  status      ResultStatus @default(DRAFT)
  teacherComment String?
  hodComment  String?
  adminComment String?
  submittedAt DateTime?
  approvedAt  DateTime?
  publishedAt DateTime?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Relations
  school      School       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  student     Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  subject     Subject      @relation(fields: [subjectId], references: [id])
  teacher     Teacher      @relation(fields: [teacherId], references: [id])

  @@unique([studentId, subjectId, academicYear, term])
  @@index([schoolId])
  @@map("results")
}

// ============================================
// EXAMINATION SYSTEM
// ============================================

enum ExamStatus {
  DRAFT
  SCHEDULED
  ACTIVE
  COMPLETED
  CANCELLED
}

model Exam {
  id          String     @id @default(cuid())
  schoolId    String
  title       String
  subjectId   String
  classId     String
  duration    Int
  totalMarks  Int        @default(60)
  instructions String?
  scheduledAt DateTime?
  startTime   DateTime?
  endTime     DateTime?
  status      ExamStatus @default(DRAFT)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relations
  school      School     @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  subject     Subject    @relation(fields: [subjectId], references: [id])
  class       Class      @relation(fields: [classId], references: [id])
  questions   Question[]
  attempts    ExamAttempt[]

  @@index([schoolId])
  @@map("exams")
}

enum QuestionType {
  MULTIPLE_CHOICE
  TRUE_FALSE
  ESSAY
}

model Question {
  id          String       @id @default(cuid())
  examId      String
  type        QuestionType
  question    String
  options     String[]
  correctAnswer String?
  marks       Float        @default(1)
  order       Int
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Relations
  exam        Exam         @relation(fields: [examId], references: [id], onDelete: Cascade)
  answers     Answer[]

  @@map("questions")
}

enum AttemptStatus {
  IN_PROGRESS
  SUBMITTED
  MARKED
}

model ExamAttempt {
  id          String        @id @default(cuid())
  examId      String
  studentId   String
  startedAt   DateTime      @default(now())
  submittedAt DateTime?
  score       Float?
  status      AttemptStatus @default(IN_PROGRESS)
  violations  Int           @default(0)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relations
  exam        Exam          @relation(fields: [examId], references: [id])
  student     Student       @relation(fields: [studentId], references: [id])
  answers     Answer[]

  @@unique([examId, studentId])
  @@map("exam_attempts")
}

model Answer {
  id          String      @id @default(cuid())
  attemptId   String
  questionId  String
  answer      String
  isCorrect   Boolean?
  marksAwarded Float?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  attempt     ExamAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  question    Question    @relation(fields: [questionId], references: [id])

  @@unique([attemptId, questionId])
  @@map("answers")
}

// ============================================
// SYSTEM CONFIGURATION
// ============================================

model AcademicYear {
  id          String   @id @default(cuid())
  schoolId    String
  year        String
  startDate   DateTime
  endDate     DateTime
  currentTerm Term     @default(FIRST)
  isCurrent   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  school      School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@unique([schoolId, year])
  @@index([schoolId])
  @@map("academic_years")
}

model GradingScale {
  id          String   @id @default(cuid())
  schoolId    String
  grade       Grade
  minScore    Float
  maxScore    Float
  remark      String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  school      School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([schoolId])
  @@map("grading_scales")
}

// ============================================
// PLATFORM MANAGEMENT
// ============================================

enum BugPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum BugStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

model BugReport {
  id          String      @id @default(cuid())
  schoolId    String?
  userId      String?
  title       String
  description String
  priority    BugPriority @default(MEDIUM)
  status      BugStatus   @default(OPEN)
  attachments Json?
  assignedTo  String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  school      School?     @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([schoolId])
  @@map("bug_reports")
}



// ============================================
// SECURITY MODELS
// ============================================

// Track password history to prevent reuse
model PasswordHistory {
  id          String   @id @default(cuid())
  userId      String
  passwordHash String
  createdAt   DateTime @default(now())
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@map("password_history")
}


// Track login attempts for rate limiting and security
model LoginAttempt {
  id            String   @id @default(cuid())
  userId        String?
  email         String
  ipAddress     String
  userAgent     String?
  success       Boolean
  failureReason String?
  createdAt     DateTime @default(now())
  
  user          User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([email, createdAt])
  @@index([ipAddress, createdAt])
  @@map("login_attempts")
}


// Manage active sessions
model Session {
  id             String   @id @default(cuid())
  userId         String
  token          String   @unique
  refreshToken   String?  @unique
  ipAddress      String
  userAgent      String?
  expiresAt      DateTime
  lastActivityAt DateTime @default(now())
  createdAt      DateTime @default(now())
  
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("sessions")
}


// Password reset tokens
model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  usedAt    DateTime?
  createdAt DateTime @default(now())
  
  @@index([email])
  @@index([token])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}


// Comprehensive audit logging
model AuditLog {
  id           String   @id @default(cuid())
  userId       String?
  schoolId     String?
  action       String
  resource     String?
  resourceId   String?
  ipAddress    String?
  userAgent    String?
  success      Boolean
  errorMessage String?
  metadata     Json?
  createdAt    DateTime @default(now())
  
  user         User?    @relation(fields: [userId], references: [id])
  
  @@index([userId])
  @@index([schoolId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}
